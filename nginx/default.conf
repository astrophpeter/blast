upstream app {
	server app:8000;
}

server {
	listen 80;

	location / {
		proxy_pass http://app/;
	}

	location /static/ {
		alias /static/;
	}

    location /rabbitmq {
          proxy_pass http://rabbitmq:15672/;
          rewrite ^/rabbitmq/(.*)$ /$1 break;
    }

    location /flower-internal/static/ {
          internal;
          include  /etc/nginx/mime.types;
          sub_filter '/api' '/flower/api';
          sub_filter "'/monitor" "'/flower/monitor";
          sub_filter "'/worker" "'/flower/worker";
          sub_filter "'/'" "'/flower/'";
          sub_filter "'/dashboard" "'/flower/dashboard";
          sub_filter '"/update-dashboard"' '"/flower/update-dashboard"';
          sub_filter_types application/javascript;  # by default, sub_filter won't touch JS
          sub_filter_last_modified on;
          sub_filter_once off;
          rewrite ^/flower-internal/static/(.*)$ /$1 break;
          root <PATH_TO_PYTHON/VENV_DIR>/site-packages/flower/static/;
          add_header Content-Type text/css;
        }

        location /flower-internal/ {
            internal;
            rewrite ^/flower-internal/(.*)$ /$1 break;
            sub_filter '="/' '="/flower/';
            sub_filter_last_modified on;
            sub_filter_once off;

            proxy_pass http://flower:8888;
            proxy_set_header Host $host;
        }
}
